lvs + keepalived 搭建
1.规划
1台主lvs：172.22.3.101
1台备lvs：172.22.3.102
1台vip：172.22.3.103

2.两台webServer的配置
（1）在线安装httpd，第一台和第二台都执行
   yum -y install httpd
（2）设置开机自启动
   systemctl enable httpd
（3）开启http服务器
   systemctl start httpd
（4）配置index.html通过浏览器访问http服务器，默认端口是80
   vim /var/www/html/index.html
  <h1> 主机IP </h1>

 （5）创建文件并写入如下内容
访问 http://172.22.3.101
访问 http://172.22.3.102

（6）创建文件并写入如下内容
cat /etc/init.d/realserver 

#!/bin/bash
# description: Config realserver lo and apply noarp
SNS_VIP=172.22.3.103
/etc/rc.d/init.d/functions
case "$1" in
start)
       ifconfig lo:0 $SNS_VIP netmask 255.255.255.255 broadcast $SNS_VIP
       /sbin/route add -host $SNS_VIP dev lo:0
       echo "1" >/proc/sys/net/ipv4/conf/lo/arp_ignore
       echo "2" >/proc/sys/net/ipv4/conf/lo/arp_announce
       echo "1" >/proc/sys/net/ipv4/conf/all/arp_ignore
       echo "2" >/proc/sys/net/ipv4/conf/all/arp_announce
       sysctl -p >/dev/null 2>&1
       echo "RealServer Start OK"
       ;;
stop)
       ifconfig lo:0 down
       route del $SNS_VIP >/dev/null 2>&1
       echo "0" >/proc/sys/net/ipv4/conf/lo/arp_ignore
       echo "0" >/proc/sys/net/ipv4/conf/lo/arp_announce
       echo "0" >/proc/sys/net/ipv4/conf/all/arp_ignore
       echo "0" >/proc/sys/net/ipv4/conf/all/arp_announce
       echo "RealServer Stoped"
       ;;
*)
       echo "Usage: $0 {start|stop}"
       exit 1
esac
exit 0

（7）给脚本赋权限
chmod +x /etc/init.d/functions
chmod +x /etc/init.d/realserver

（8）启动脚本
service realserver start

（9）用ifconfig查看效果
lo:0: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 172.22.3.103  netmask 255.255.255.255
        loop  txqueuelen 1000  (Local Loopback)

（10）第二台http也同样做上面步骤，增加路由，SNS_VIP要跟第一台一样

（11）安装lvs
yum -y install ipvsadm

（12）lvs的机器安装keepalived，做心跳检查用的
yum -y install keepalived

（13）查看配置文件安装位置
rpm  -ql  keepalived

（14）编辑配置文件master节点
cat /etc/keepalived/keepalived.conf

global_defs {                       
#   notification_email {             
#   }
#   smtp_connect_timeout 30
        router_id LVS_DEVEL    #表示运行keepalived服务器的一个标识。发邮件时显示在邮件主题的信息
}
vrrp_instance VI_1 {            
        state MASTER    #指定keepalived的角色，MASTER表示此主机是主服务器，BACKUP表示此主机是备用服务器       
        interface eth0     #配置LVS机器对外开放的ifcfg    
        virtual_router_id 51   #虚拟路由标识，这个标识是一个数字，同一个vrrp实例使用唯一的标识。即同一vrrp_instance下，MASTER和BACKUP必须是一致的     
        priority 100      #定义优先级，数字越大，优先级越高，主DR必须大于备用DR            
        advert_int 1      #设定MASTER与BACKUP负载均衡器之间同步检查的时间间隔，单位是秒      
        authentication {        
                auth_type PASS
                auth_pass 1111
        }
        virtual_ipaddress {         
                172.22.3.103    #设置虚拟IP地址，可以设置多个虚拟IP地址，每行一个
        }
}
virtual_server 172.22.3.103 80 {   #设置虚拟服务器，需要指定虚拟IP地址和服务端口，IP与端口之间用空格隔开
        delay_loop 6           #设置运行情况检查时间，单位是秒
        lb_algo rr            #设置负载调度算法，这里设置为rr，即轮询算法
        lb_kind DR        #设置LVS实现负载均衡的机制，有NAT、TUN、DR三个模式可选              
        nat_mask 255.255.255.0   
        persistence_timeout 0    
        protocol TCP                          
        real_server 172.22.3.101 80 {    #真实服务的IP 
                weight 1        #配置加权轮询的权重             
                TCP_CHECK {                     
                        connect_timeout 3   #表示3秒无响应超时
                        nb_get_retry 3      #表示重试次数
                        delay_before_retry 3    #表示重试间隔
                        connect_port 80
                }
        }
        real_server 172.22.3.102 80 {
                weight 1
                TCP_CHECK {
                        connect_timeout 10
                        nb_get_retry 3
                        delay_before_retry 3
                        connect_port 80
                }
        }
}

（16）开启LVS机器的keepalived
systemctl enable keepalived
systemctl start  keepalived

3.LVS备机搭建
（1）步骤同主机搭建，一直到配置文件，如下

global_defs {                       
#   notification_email {             
#   }
#   smtp_connect_timeout 30
        router_id LVS_DEVEL             
}
vrrp_instance VI_1 {            
        state BACKUP    #配置LVS是主机的状态        
        interface eth0     #配置LVS机器对外开放的ifcfg
        virtual_router_id 51        
        priority 90                  
        advert_int 1           
        authentication {        
                auth_type PASS
                auth_pass 1111
        }
        virtual_ipaddress {         
                172.22.3.103    #LVS的对内IP
        }
}
virtual_server 172.22.3.103 80 {
        delay_loop 6           
        lb_algo wrr            
        lb_kind DR         #使用LVSDR模式                 
        nat_mask 255.255.255.0   
        persistence_timeout 0    
        protocol TCP                          
        real_server 172.22.3.101 80 {    #真实服务的IP 
                weight 1        #配置加权轮询的权重             
                TCP_CHECK {                     
                        connect_timeout 3   
                        nb_get_retry 3
                        delay_before_retry 3
                        connect_port 80
                }
        }
        real_server 172.22.3.102 80 {
                weight 1
                TCP_CHECK {
                        connect_timeout 3
                        nb_get_retry 3
                        delay_before_retry 3
                        connect_port 80
                }
        }
}

（2）开启LVS机器的keepalived
systemctl enable keepalived
systemctl start  keepalived


4.LVS主备测试
master节点：
[root@172-22-3-101 keepalived]# ip  a
 eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:7d:b6:b3 brd ff:ff:ff:ff:ff:ff
    inet 172.22.3.101/16 brd 172.22.255.255 scope global noprefixroute eth0
       valid_lft forever preferred_lft forever
    inet 172.22.3.103/32 scope global eth0

backup节点：
[root@172-22-3-102 keepalived]# ip  a
eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:5d:10:4a brd ff:ff:ff:ff:ff:ff
    inet 172.22.3.102/16 brd 172.22.255.255 scope global noprefixroute eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::e0db:62ee:d33:4b7c/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever

（1）主LVS模拟挂掉

（2）测试后，证明主备自动切换，LVS高可用

（3）主LVS启动，自动上位
